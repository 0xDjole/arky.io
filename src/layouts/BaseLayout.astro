---
import { type CollectionEntry } from "astro:content";

import BaseHead from "@layouts/BaseHead.astro";
import Nav from "@components/Nav/Nav.astro";
import Footer from "@components/Footer/Footer.astro";
import "@/styles/global.css";

import { getLocale } from "@lib/i18n";
import { arky } from "@lib/arky";

// Set locale - that's all BaseLayout does
const currLocale = getLocale(Astro.currentLocale);
arky.setLocale(currLocale);

// Fetch website metadata for BaseHead
const websiteNode = await arky.cms.getNode({ id: "website" });
const siteData = websiteNode.getBlock("info");

// Extract multilingual site info
const siteTitle = typeof siteData.title === 'string' 
	? siteData.title 
	: (siteData.title?.[currLocale] || siteData.title?.en || siteData.title?.[Object.keys(siteData.title || {})[0]] || 'Site');

const siteDescription = typeof siteData.description === 'string'
	? siteData.description
	: (siteData.description?.[currLocale] || siteData.description?.en || siteData.description?.[Object.keys(siteData.description || {})[0]] || '');
---

<!doctype html>
<html lang={currLocale} class="use-animations" transition:animate="fade">
	<head>
		<BaseHead
			type="general"
			title={siteTitle}
			description={siteDescription}
		/>
	</head>
	<body id="body" class="">
		<div class="min-h-[100lvh]">
			<Nav />
			<main class="">
				<slot />
			</main>
		</div>
		<Footer />

		<!-- Toast notifications -->
		<div id="toast-container"></div>

		<!-- Floating cart -->
		<div id="floating-cart-container"></div>

		<!-- GSAP animations handled in BaseHead -->

		<!-- Toast notifications -->
		<script>
			import { mount } from "svelte";
			import Toast from "@components/Toast/Toast.svelte";
			import FloatingCart from "@lib/Cart/FloatingCart.svelte";
			import { arky } from "@lib/arky";
			import { getLocaleFromUrl } from "@lib/i18n";

			// Mount toast component
			let toastComponent;
			let floatingCartComponent;

			function mountToast() {
				const container = document.getElementById('toast-container');
				if (container && !toastComponent) {
					toastComponent = mount(Toast, { target: container });
				}
			}

			function mountFloatingCart() {
				const container = document.getElementById('floating-cart-container');
				if (container && !floatingCartComponent) {
					floatingCartComponent = mount(FloatingCart, { target: container });
				}
			}

			function syncLocale() {
				const locale = getLocaleFromUrl(new URL(window.location.href));
				arky.setLocale(locale);
			}

			// Mount on initial load
			mountToast();
			mountFloatingCart();
			syncLocale();

			// Mount after view transitions
			document.addEventListener("astro:after-swap", () => {
				mountToast();
				mountFloatingCart();
				syncLocale();
			});
		</script>
	</body>
</html>
