---
import BaseLayout from "@layouts/BaseLayout.astro";
import { defaultLocale, getLocale, locales } from "@lib/i18n";
import { arky, getBlockFromArray } from "@lib/index";
import Service from "@lib/Reservation/Service/index.svelte";
import appConfig from "../../../appConfig";

export async function getStaticPaths() {
	const res = await fetch(`${appConfig.apiUrl}/v1/businesses/${appConfig.businessId}/services?limit=100`);

	if (!res.ok) {
		return [];
	}

	const { items } = await res.json();

	return items.flatMap((service) =>
		locales.map((locale) => ({
			params: {
				slug: service.slug,
				locale: locale === defaultLocale ? undefined : locale,
			},
			props: { locale },
		})),
	);
}

const { slug } = Astro.params;

const serviceRes = await fetch(`${appConfig.apiUrl}/v1/businesses/${appConfig.businessId}/services/${slug}`);
const service = await serviceRes.json();

const currLocale = getLocale(Astro.currentLocale);
arky.setLocale(currLocale);
const websiteCollection = await arky.cms.getCollection({ id: "website" });
const siteData = getBlockFromArray(websiteCollection, "info", currLocale);

// Extract strings (handle multilingual objects)
const siteTitle = typeof siteData.title === 'string' ? siteData.title : (siteData.title?.en || siteData.title?.[Object.keys(siteData.title || {})[0]] || 'Site');
const siteDescription = typeof siteData.description === 'string' ? siteData.description : (siteData.description?.en || siteData.description?.[Object.keys(siteData.description || {})[0]] || '');
---

<BaseLayout title={siteTitle} description={siteDescription}>
	<Service client:load service={service} />
</BaseLayout>
