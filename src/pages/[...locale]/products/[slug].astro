---
import BaseLayout from "@layouts/BaseLayout.astro";
import ProductDetail from "@lib/EShop/ProductDetail/index.svelte";
import { arky, getBlockFromArray, getImageUrl } from "@lib/index";
import { defaultLocale, getLocale, locales } from "@lib/i18n";
import appConfig from "../../../appConfig";

export async function getStaticPaths() {
	try {
		const res = await fetch(`${appConfig.apiUrl}/v1/businesses/${appConfig.businessId}/products?status=ACTIVE&limit=100`);

		if (!res.ok) {
			console.error('Failed to fetch products:', res.status, res.statusText);
			return [];
		}

		const data = await res.json();
		const items = data.items || [];

		return items.flatMap((product) =>
			locales.map((locale) => {
				const slug = product.seo?.slug?.[locale] || product.seo?.slug?.en;
				if (!slug) return null;

				return {
					params: {
						slug: slug,
						locale: locale === defaultLocale ? undefined : locale,
					},
					props: { locale },
				};
			}).filter(Boolean),
		);
	} catch (error) {
		console.error('Error fetching products for static paths:', error);
		return [];
	}
}

const { slug } = Astro.params;
const currLocale = getLocale(Astro.currentLocale);

let product = null;
try {
	const productId = `${appConfig.businessId}:${currLocale}:${slug}`;
	const productRes = await fetch(`${appConfig.apiUrl}/v1/businesses/${appConfig.businessId}/products/${productId}`);

	if (!productRes.ok) {
		throw new Error(`Failed to fetch product: ${productRes.status} ${productRes.statusText}`);
	}

	product = await productRes.json();
} catch (error) {
	console.error('Error fetching product:', error);
	// Return 404 if product not found
	return Astro.redirect("/404");
}
arky.setLocale(currLocale);
const websiteCollection = await arky.cms.getCollection({ id: "website" });
const siteData = getBlockFromArray(websiteCollection, "info", currLocale);

// Extract title string (handle multilingual objects)
const siteTitle = typeof siteData.title === 'string' ? siteData.title : (siteData.title?.en || siteData.title?.[Object.keys(siteData.title || {})[0]] || 'Site');
---

<BaseLayout title={`${product.name} - ${siteTitle}`} description={product.description}>
	<ProductDetail {product} client:load />
</BaseLayout>
