---
import BaseLayout from "@layouts/BaseLayout.astro";
import ProductDetail from "@lib/EShop/ProductDetail/index.svelte";
import { arky } from "@lib/index";
import { defaultLocale, locales } from "@lib/i18n";
import appConfig from "../../../appConfig";

export async function getStaticPaths() {
	try {
		const res = await fetch(`${appConfig.apiUrl}/v1/businesses/${appConfig.businessId}/products?status=ACTIVE&limit=100`);

		if (!res.ok) {
			console.error('Failed to fetch products:', res.status, res.statusText);
			return [];
		}

		const data = await res.json();
		const items = data.items || [];

		return items.flatMap((product) =>
			locales.map((locale) => {
				const slug = product.seo?.slug?.[locale];
				// Skip if no slug for this specific locale
				if (!slug) return null;

				return {
					params: {
						slug: slug,
						locale: locale === defaultLocale ? undefined : locale,
					},
					props: { locale },
				};
			}).filter(Boolean),
		);
	} catch (error) {
		console.error('Error fetching products for static paths:', error);
		return [];
	}
}

const { slug } = Astro.params;

let product = null;
try {
	product = await arky.eshop.getProduct({ id: slug });
} catch (error) {
	console.error('Error fetching product:', error);
	// Return 404 if product not found
	return Astro.redirect("/404");
}
---

<BaseLayout>
	<ProductDetail {product} client:load />
</BaseLayout>
